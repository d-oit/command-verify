name: Dependency Updates

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Setup Environment
        uses: ./.github/actions/environment-setup
        with:
          node-version: '20.x'
          environment: 'development'

      - name: Security audit before updates
        run: |
          echo "ğŸ”’ Running security audit before applying updates..."
          npm audit --audit-level=moderate || echo "âš ï¸ Security issues found, proceeding with caution"

      - name: Dependency Management
        uses: ./.github/actions/dependency-management
        with:
          action: 'update'
          update-strategy: 'patch'
          create-pr: 'true'

      - name: Security audit after updates
        uses: ./.github/actions/dependency-management
        with:
          action: 'audit'
          audit-level: 'moderate'

      - name: Create status comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const message = status === 'success' 
              ? 'âœ… Dependency updates completed successfully'
              : 'âŒ Dependency update process failed';
            
            console.log(message);