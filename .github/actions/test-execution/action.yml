name: 'Test Execution'
description: 'Comprehensive test execution with coverage reporting and caching'
inputs:
  test-command:
    description: 'Test command to run'
    required: false
    default: 'npm run test:coverage'
  coverage-format:
    description: 'Coverage output format'
    required: false
    default: 'lcov'
  upload-coverage:
    description: 'Upload coverage to external service'
    required: false
    default: 'true'
  codecov-token:
    description: 'Codecov token for coverage upload'
    required: false
    default: ''
  coverage-threshold:
    description: 'Minimum coverage percentage required'
    required: false
    default: '80'
  parallel:
    description: 'Run tests in parallel'
    required: false
    default: 'true'
  verbose:
    description: 'Verbose test output'
    required: false
    default: 'false'

outputs:
  test-result:
    description: 'Test execution result (pass/fail)'
    value: ${{ steps.test-result.outputs.result }}
  coverage-percentage:
    description: 'Total coverage percentage'
    value: ${{ steps.coverage-summary.outputs.percentage }}
  tests-run:
    description: 'Number of tests run'
    value: ${{ steps.coverage-summary.outputs.tests }}

runs:
  using: 'composite'
  steps:
    - name: Install system dependencies
      shell: bash
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y bc jq

    - name: Cache ESLint results
      uses: actions/cache@v4
      with:
        path: .eslintcache
        key: eslint-${{ runner.os }}-${{ hashFiles('eslint.config.js', 'lib/**/*.js', '__tests__/**/*.js', 'scripts/**/*.js') }}
        restore-keys: |
          eslint-${{ runner.os }}-
          npm-${{ runner.os }}-

    - name: Cache test results
      uses: actions/cache@v4
      with:
        path: .vitest-cache
        key: vitest-${{ runner.os }}-${{ hashFiles('vitest.config.js', 'lib/**/*.js', '__tests__/**/*.js') }}
        restore-keys: |
          vitest-${{ runner.os }}-
          npm-${{ runner.os }}-

    - name: Install dependencies
      shell: bash
      run: |
        if npm ci; then
          echo "âœ… Dependencies installed successfully with npm ci"
        elif npm install --legacy-peer-deps; then
          echo "âš ï¸ npm ci failed, fallback to npm install with --legacy-peer-deps"
        elif npm install; then
          echo "âš ï¸ npm ci failed, fallback to npm install"
        else
          echo "âŒ All installation methods failed"
          exit 1
        fi

    - name: Run linter with cache
      id: lint
      shell: bash
      run: npm run lint
      env:
        ESLINT_CACHE: .eslintcache

    - name: Lint summary
      if: always()
      shell: bash
      run: |
        echo "### ðŸ“ Lint Results" >> $GITHUB_STEP_SUMMARY
        if [ $? -eq 0 ]; then
          echo "âœ… ESLint passed with no issues" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ESLint found issues" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Run tests with coverage
      id: test
      shell: bash
      run: |
        TEST_ARGS="--reporter=verbose"
        if [ "${{ inputs.parallel }}" = "true" ]; then
          TEST_ARGS="$TEST_ARGS --pool=threads --poolOptions.threads.isolate=false"
        fi
        
        if [ "${{ inputs.verbose }}" = "true" ]; then
          TEST_ARGS="$TEST_ARGS --reporter=verbose"
        fi
        
        eval "${{ inputs.test-command }} $TEST_ARGS"

      env:
        VITEST_CACHE_DIR: .vitest-cache
        CI: true

    - name: Test result
      id: test-result
      shell: bash
      run: |
        if [ $? -eq 0 ]; then
          echo "result=pass" >> $GITHUB_OUTPUT
          echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "result=fail" >> $GITHUB_OUTPUT
          echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Generate coverage summary
      id: coverage-summary
      shell: bash
      run: |
        if [ -f "coverage/lcov.info" ]; then
          PERCENTAGE=$(grep -o '[0-9]\+\.[0-9]\+%' coverage/lcov.info | tail -1 | sed 's/%//' || echo "0")
          TESTS=$(find __tests__ -name "*.test.js" | wc -l || echo "0")
          
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "tests=$TESTS" >> $GITHUB_OUTPUT
          
          echo "### ðŸ“Š Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage**: $PERCENTAGE%" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: $TESTS test files" >> $GITHUB_STEP_SUMMARY
        else
          echo "percentage=0" >> $GITHUB_OUTPUT
          echo "tests=0" >> $GITHUB_OUTPUT
          echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check coverage threshold
      id: coverage-check
      shell: bash
      run: |
        COVERAGE=${{ steps.coverage-summary.outputs.percentage }}
        THRESHOLD=${{ inputs.coverage-threshold }}
        
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "âŒ Coverage $COVERAGE% is below threshold $THRESHOLD%" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… Coverage $COVERAGE% meets threshold $THRESHOLD%" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload coverage to Codecov
      if: inputs.upload-coverage == 'true' && inputs.codecov-token != ''
      uses: codecov/codecov-action@v4
      with:
        token: ${{ inputs.codecov-token }}
        files: ./coverage/lcov.info
        fail_ci_if_error: false
        verbose: true
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

    - name: Skip coverage upload if token missing
      if: inputs.upload-coverage == 'true' && inputs.codecov-token == ''
      shell: bash
      run: |
        echo "âš ï¸ Codecov token not configured, skipping coverage upload" >> $GITHUB_STEP_SUMMARY

    - name: Coverage upload alternative
      if: inputs.upload-coverage == 'true' && inputs.codecov-token == '' && always()
      shell: bash
      run: |
        echo "âš ï¸ No Codecov token available, coverage report available locally" >> $GITHUB_STEP_SUMMARY
        if [ -f "./coverage/lcov.info" ]; then
          echo "ðŸ“Š Coverage report generated at: ./coverage/lcov.info" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ Configure CODECOV_TOKEN secret to enable automatic upload" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      if: always()
      with:
        format: spdx
        output-file: sbom.spdx.json

    - name: Test execution summary
      if: always()
      shell: bash
      run: |
        echo "### ðŸ§ª Test Execution Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: ${{ steps.test-result.outputs.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Coverage**: ${{ steps.coverage-summary.outputs.percentage }}%" >> $GITHUB_STEP_SUMMARY
        echo "**Tests**: ${{ steps.coverage-summary.outputs.tests }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.test-result.outputs.result }}" = "pass" ]; then
          echo "ðŸŽ‰ All quality checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸš¨ Quality checks failed" >> $GITHUB_STEP_SUMMARY
        fi